name: Update Release Metadata

on:
  workflow_dispatch:

jobs:
  update-metadata:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout releases-repo
        uses: actions/checkout@v4
        with:
          path: releases-repo
      
      - name: Get all releases info
        id: get_releases
        run: |
          # Get all releases from GitHub API for go3t project as example
          RESPONSE=$(curl -s -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/HoteiApp-testing/go3t/releases")
          
          # Process all releases and create JSON array
          RELEASES_ARRAY="[]"
          
          echo "$RESPONSE" | jq -c '.[]' | while read release; do
            VERSION=$(echo "$release" | jq -r '.tag_name' | sed 's/^v//')
            RELEASE_URL=$(echo "$release" | jq -r '.assets[0].browser_download_url')
            ALL_RELEASES_URL="https://github.com/HoteiApp-testing/go3t/releases"
            DATE=$(echo "$release" | jq -r '.published_at' | cut -d'T' -f1)
            
            # Create release object
            RELEASE_OBJ=$(jq -n --arg version "$VERSION" \
                              --arg releaseUrl "$RELEASE_URL" \
                              --arg allReleasesUrl "$ALL_RELEASES_URL" \
                              --arg date "$DATE" \
                              '{version: $version, releaseUrl: $releaseUrl, allReleasesUrl: $allReleasesUrl, date: $date}')
            
            # Add to releases array
            RELEASES_ARRAY=$(echo "$RELEASES_ARRAY" | jq -c --argjson newRelease "$RELEASE_OBJ" '. + [$newRelease]')
          done
          
          # Save releases array to output
          echo "releases_array=$RELEASES_ARRAY" >> $GITHUB_OUTPUT
      
      - name: Create project directory if not exists
        run: |
          mkdir -p releases-repo/metadata/go3t
      
      - name: Generate releases.json
        run: |
          PROJECT_DIR="releases-repo/metadata/go3t"
          RELEASES_FILE="$PROJECT_DIR/releases.json"
          
          # Get releases array from previous step
          RELEASES_ARRAY='${{ steps.get_releases.outputs.releases_array }}'
          
          # Create final JSON structure
          jq -n --argjson releases "$RELEASES_ARRAY" '{releases: $releases}' > "$RELEASES_FILE"
      
      - name: Commit and push changes
        run: |
          cd releases-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add metadata/go3t/releases.json
          git commit -m "Update metadata for go3t releases"
          git push
